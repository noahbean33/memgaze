# -*-Mode: makefile;-*-

# Common MIAMI make rules
##############################################################
#
# set up and include *.config files
#
##############################################################

KIT = 1
TARGET_OS = linux

MIAMI_LIBRARY_PATHS = $(BINUTILS_ROOT)/lib:$(BINUTILS_ROOT)/lib64:$(DYNINST_LIB):$(XED_LIB)

#****************************************************************************

COMP_OBJ += -c -o
LINK_EXE += -o

#****************************************************************************

DYNINST_CXXFLAGS = -I$(DYNINST_INC) -I$(BOOST_INC)
DYNINST_LDFLAGS = \
	-L$(DYNINST_LIB) -Wl,-rpath $(DYNINST_LIB) \
	-ldyninstAPI \
	-lsymtabAPI \
	-lparseAPI \
	-lpatchAPI \
	-linstructionAPI \
	-lstackwalk \
	-lpcontrol \
	-ldynElf \
	-ldynDwarf \
	-lcommon

XED_CXXFLAGS = -I$(XED_INC)
XED_LDFLAGS = \
	-L$(XED_LIB) -Wl,-rpath $(XED_LIB) \
	-lxed

BINUTILS_CFLAGS = -I$(BINUTILS_ROOT)/include
BINUTILS_LDFLAGS = \
	-L$(BINUTILS_ROOT)/lib -L$(BINUTILS_ROOT)/lib64 \
	-lbfd -liberty

#****************************************************************************

TARGET_COMPILER?=gnu

ifeq ($(TARGET_COMPILER),gnu)
    DBG ?= -g
    OPT ?= -O3
    WFLAGS = -Wall -Wno-error -Wno-unknown-pragmas -Wno-unused-function \
         -fno-strict-aliasing
    WXXFLAGS = -Woverloaded-virtual
    CXXFLAGS ?= -fPIC $(DBG) $(OPT) $(WFLAGS) $(WXXFLAGS) $(DYNINST_CXXFLAGS) $(XED_CXXFLAGS) -I. -I../common -I..
    CFLAGS ?= -fPIC $(DBG) $(OPT) $(WFLAGS) -I. -I../common -I..
endif

MIAMI_TARGET ?= $(PALM_MIAMI_ROOT)/install
BINDIR = $(MIAMI_TARGET)/bin/
EXEDIR = $(BINDIR)libexec/
OBJDIR = $(PALM_MIAMI_ROOT)/objs/
ETCDIR = $(MIAMI_TARGET)/etc
VARSDIR = $(ETCDIR)/vars
ifeq ($(MIAMI_KIT),1)
   VARSFILE = $(ETCDIR)/miami_vars
else
   VARSFILE = $(ETCDIR)/vars/$(TOOL_VAR)
endif

BINSCRIPT ?= $(PALM_MIAMI_ROOT)/src/tools/run_tool.in

$(OBJDIR)pinobj/%.o : %.cpp
	$(CXX) $(TOOL_CXXFLAGS) $(CXXFLAGS) $(COMP_OBJ)$@ $<

$(OBJDIR)pinobj/%.o : %.C
	$(CXX) $(TOOL_CXXFLAGS) $(CXXFLAGS) $(COMP_OBJ)$@ $<

$(OBJDIR)pinobj/%.o : %.c
	$(CC) $(TOOL_CFLAGS) $(CFLAGS) $(COMP_OBJ)$@ $<

$(OBJDIR)pinstatic/%.o : %.C
	$(CXX) $(TOOL_CXXFLAGS) -DSTATIC_COMPILATION $(CXXFLAGS) $(COMP_OBJ)$@ $<

$(OBJDIR)$(TOOL_OBJ_DIR)/%.o : %.cpp
	$(CXX) $(CXXFLAGS) -c -o $@ $<

$(OBJDIR)$(TOOL_OBJ_DIR)/%.o : %.C
	$(CXX) $(CXXFLAGS) -c -o $@ $<

$(OBJDIR)$(TOOL_OBJ_DIR)/%.o : %.c
	$(CC) $(CFLAGS) -c -o $@ $<

$(OBJDIR)common/source_file_mapping_binutils.o : source_file_mapping_binutils.C
	$(CXX) $(CXXFLAGS) $(BINUTILS_CFLAGS) -c -o $@ $<

$(OBJDIR)common/%.o : %.cpp
	$(CXX) $(CXXFLAGS) -c -o $@ $<

$(OBJDIR)common/%.o : %.C
	$(CXX) $(CXXFLAGS) -c -o $@ $<

$(OBJDIR)common/%.o : %.c
	$(CC) $(CFLAGS) -c -o $@ $<

$(OBJDIR)oautils/%.o : %.C
	$(CXX) $(CXXFLAGS) -c -o $@ $<

$(OBJDIR)tarjans/%.o : %.C
	$(CXX) $(CXXFLAGS) -c -o $@ $<

$(OBJDIR)tarjans/%.oo : %.C
	$(CXX) $(CXXFLAGS) -c -o $@ $<


info:
	@echo "DYNINST_ROOT=$(DYNINST_ROOT)"
	@echo "PALM_MIAMI_ROOT=$(PALM_MIAMI_ROOT)"
	@echo "MIAMI_TARGET=$(MIAMI_TARGET)"
	@echo "TOOL_OBJ_DIR=$(TOOL_OBJ_DIR)"
	@echo "TOOL_CXXFLAGS=$(TOOL_CXXFLAGS)"
	@echo "COMP_OBJ=$(COMP_OBJ)"

all: tools
	mkdir -p $(VARSDIR)
	@echo "MIAMI_LIBRARY_PATHS=$(MIAMI_LIBRARY_PATHS)" >> $(VARSFILE)

tools: $(OBJDIR) $(EXEDIR) $(TOOLS)

$(EXEDIR): .force
	mkdir -p $(BINDIR)
	mkdir -p $(EXEDIR)

clean:
	-rm -rf $(OBJS) $(MAIN_PIN_OBJS) *.out *.tested *.failed makefile.copy *~

cleanall distclean: clean
	-rm -rf $(MIAMI_TARGET) $(OBJDIR)
